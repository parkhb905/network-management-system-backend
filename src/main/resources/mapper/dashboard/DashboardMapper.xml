<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.network.nms.mapper.dashboard.DashboardMapper">

    <select id="selectDeviceCountByType" resultType="map">
        SELECT
            cd.code_name AS deviceType
            , COUNT(cd.code) AS count
        FROM
            device dv
        INNER JOIN
            code cd
        ON
            dv.device_type_id = cd.code_id
        WHERE
            dv.deleted = FALSE
        AND
            cd.deleted = FALSE
        GROUP BY
            cd.code
        ORDER BY
            count DESC
    </select>

    <select id="selectDeviceCountByVendor" resultType="map">
        SELECT
            cd.code_name AS vendor
            , COUNT(cd.code) AS count
        FROM
            device dv
        INNER JOIN
            code cd
        ON
            dv.vendor_id = cd.code_id
        WHERE
            dv.deleted = FALSE
        AND
            cd.deleted = FALSE
        GROUP BY
            cd.code
        ORDER BY
            count DESC
    </select>

    <select id="selectTop5CpuUsage" 
            parameterType="String" 
            resultType="com.network.nms.dto.dashboard.DeviceCpuUsageResponse">
        SELECT
            dv.device_name AS deviceName
            , ROUND(AVG(resource.cpu_usage), 2) AS avgCpuUsage
            , MAX(resource.collected_at) AS collectedAt
        FROM
            system_resource resource
        INNER JOIN
            device dv
        ON
            dv.device_id = resource.device_id
        WHERE
            dv.deleted = FALSE
        AND
            resource.collected_at BETWEEN DATE_SUB(NOW(), INTERVAL 
            <choose>
                <when test="period == '24h'">1 DAY</when>
                <when test="period == '7d'">7 DAY</when>
                <otherwise>1 DAY</otherwise>
            </choose>
            ) AND NOW()
        GROUP BY
            dv.device_id
        ORDER BY
            avgCpuUsage DESC
        LIMIT 5
    </select>

    <select id="selectTop5MemoryUsage" 
            parameterType="String"
            resultType="com.network.nms.dto.dashboard.DeviceMemoryUsageResponse">
        SELECT
            dv.device_name AS deviceName
            , ROUND(AVG(resource.memory_usage), 2) AS avgMemoryUsage
            , MAX(resource.collected_at) AS collectedAt
        FROM
            system_resource resource
        INNER JOIN
            device dv
        ON
            dv.device_id = resource.device_id
        WHERE
            dv.deleted = FALSE
        AND
            resource.collected_at BETWEEN DATE_SUB(NOW(), INTERVAL 
            <choose>
                <when test="period == '24h'">1 DAY</when>
                <when test="period == '7d'">7 DAY</when>
                <otherwise>1 DAY</otherwise>
            </choose>
            ) AND NOW()
        GROUP BY
            dv.device_id
        ORDER BY
            avgMemoryUsage DESC
        LIMIT 5
    </select>

</mapper>