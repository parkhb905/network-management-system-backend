<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.network.nms.mapper.device.DeviceMapper">

    <select id="findDevices" resultType="com.network.nms.dto.device.DeviceResponse">
        SELECT
            *
        FROM
        (
            SELECT
    <!--        카멜케이스 자동 적용되는 지 확인 -->
                #{totalElements} - ROW_NUMBER() OVER (ORDER BY dv.created_at DESC) + 1 AS rownum
                , dv.device_id AS deviceId
                , dv.device_name AS deviceName
                , dv_cd.code_name AS deviceTypeName
                , vd_cd.code_name AS vendorName
                , usr.username AS createdByName
                , dv.created_at AS createdAt
            FROM
                device dv
            INNER JOIN
                code dv_cd
            ON
                dv.device_type_id = dv_cd.code_id
            INNER JOIN
                code vd_cd
            ON
                dv.vendor_id = vd_cd.code_id
            INNER JOIN
                `user` usr
            ON
                dv.created_by = usr.id
            AND
                usr.deleted = FALSE
            WHERE
                dv.deleted = FALSE
            ORDER BY
                dv.created_at DESC
            LIMIT
                #{size}
            OFFSET
                #{offset}
        ) pagingTbl
        ORDER BY
            pagingTbl.rownum DESC;
    </select>

    <select id="countDevices" resultType="long">
        SELECT
            COUNT(dv.device_id)
        FROM
            DEVICE dv
        INNER JOIN
            code dv_cd
        ON
            dv.device_type_id = dv_cd.code_id
        INNER JOIN
            code vd_cd
        ON
            dv.vendor_id = vd_cd.code_id
        INNER JOIN
            `user` usr
        ON
            dv.created_by = usr.id
        AND
            usr.deleted = FALSE
        WHERE
            dv.deleted = FALSE
    </select>

    <insert id="insertDevice" parameterType="com.network.nms.domain.device.Device">
        INSERT INTO device (
            device_name
            , device_type_id
            , vendor_id
            , created_by
            , created_at
        ) VALUES (
            #{deviceName}
            , #{deviceTypeId}
            , #{vendorId}
            , #{createdBy}
            , NOW()
        )
    </insert>

</mapper>